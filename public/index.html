<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Spotify Search</title>
</head>
<body>
  <h1>Spotify Search</h1>
  <button onclick="authorize()">Login</button><br><br>

  <input id="query" placeholder="曲やアーティスト名" />
  <select id="type">
    <option value="track">Track</option>
    <option value="artist">Artist</option>
  </select>
  <button onclick="search()">Search</button>

  <pre id="result"></pre>

  <script>
  const CLIENT_ID = "{{CLIENT_ID}}"; // フロントでは.envを直接参照できない
  const REDIRECT_URI = window.location.origin;

  function generateCodeVerifier() {
    const array = new Uint32Array(56);
    crypto.getRandomValues(array);
    return Array.from(array, dec => ('0' + dec.toString(16)).slice(-2)).join('');
  }

  async function generateCodeChallenge(verifier) {
    const data = new TextEncoder().encode(verifier);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  }

  async function authorize() {
    const verifier = generateCodeVerifier();
    const challenge = await generateCodeChallenge(verifier);
    localStorage.setItem("code_verifier", verifier);

    const params = new URLSearchParams({
      response_type: "code",
      client_id: CLIENT_ID,
      scope: "user-read-private",
      redirect_uri: REDIRECT_URI,
      code_challenge_method: "S256",
      code_challenge: challenge
    });

    window.location = "https://accounts.spotify.com/authorize?" + params.toString();
  }

  async function handleRedirect() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    if (!code) return;

    const verifier = localStorage.getItem("code_verifier");
    const res = await fetch("/api/auth", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code, redirectUri: REDIRECT_URI, codeVerifier: verifier })
    });

    const data = await res.json();
    localStorage.setItem("access_token", data.access_token);
    localStorage.setItem("refresh_token", data.refresh_token);
    window.history.replaceState({}, document.title, "/");
  }

  async function search() {
    const token = localStorage.getItem("access_token");
    const q = document.getElementById("query").value;
    const type = document.getElementById("type").value;

    const res = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=${type}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    document.getElementById("result").textContent = JSON.stringify(data, null, 2);
  }

  handleRedirect();
  </script>
</body>
</html>
