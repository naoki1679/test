<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spotify Search App</title>
</head>
<body>
  <h1>Spotify Search</h1>

  <button onclick="authorize()">Login with Spotify</button>
  <br><br>

  <input id="query" placeholder="曲やアーティスト名を入力" />
  <select id="type">
    <option value="track">Track</option>
    <option value="artist">Artist</option>
  </select>
  <button onclick="search()">Search</button>

  <pre id="result"></pre>

  <script>
    // ===========================================
    // 設定値（環境に応じて自動切替）
    // ===========================================
    const CLIENT_ID = "{{CLIENT_ID}}"; // サーバーで埋め込む or envからbuild時に置換
    const REDIRECT_URI =
      window.location.hostname === "localhost"
        ? "http://localhost:3000"
        : "https://test-naoki1679s-projects.vercel.app";

    // ===========================================
    // PKCE Utility Functions
    // ===========================================
    function generateCodeVerifier() {
      const array = new Uint8Array(64);
      crypto.getRandomValues(array);
      return btoa(String.fromCharCode.apply(null, array))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");
    }

    async function generateCodeChallenge(verifier) {
      const data = new TextEncoder().encode(verifier);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");
    }

    // ===========================================
    // 認可リクエストを開始
    // ===========================================
    async function authorize() {
      const verifier = generateCodeVerifier();
      const challenge = await generateCodeChallenge(verifier);
      localStorage.setItem("code_verifier", verifier);

      const params = new URLSearchParams({
        response_type: "code",
        client_id: CLIENT_ID,
        scope: "user-read-private",
        redirect_uri: REDIRECT_URI,
        code_challenge_method: "S256",
        code_challenge: challenge,
      });

      window.location = "https://accounts.spotify.com/authorize?" + params.toString();
    }

    // ===========================================
    // リダイレクト時にトークン取得
    // ===========================================
    async function handleRedirect() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      if (!code) return;

      const verifier = localStorage.getItem("code_verifier");

      const res = await fetch("/api/auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          code,
          redirectUri: REDIRECT_URI,
          codeVerifier: verifier,
        }),
      });

      const data = await res.json();

      if (data.error) {
        console.error("Auth error:", data);
        alert("認証に失敗しました: " + JSON.stringify(data.error));
        return;
      }

      localStorage.setItem("access_token", data.access_token);
      localStorage.setItem("refresh_token", data.refresh_token);
      window.history.replaceState({}, document.title, "/"); // クエリを消す
    }

    // ===========================================
    // Spotify検索
    // ===========================================
    async function search() {
      const token = localStorage.getItem("access_token");
      if (!token) {
        alert("先にSpotifyにログインしてください。");
        return;
      }

      const q = document.getElementById("query").value.trim();
      const type = document.getElementById("type").value;
      if (!q) return alert("検索ワードを入力してください。");

      const res = await fetch(
        `https://api.spotify.com/v1/search?q=${encodeURIComponent(q)}&type=${type}`,
        { headers: { Authorization: `Bearer ${token}` } }
      );

      const data = await res.json();

      if (data.error) {
        console.error("Spotify API error:", data);
        alert("エラー: " + data.error.message);
      } else {
        document.getElementById("result").textContent = JSON.stringify(data, null, 2);
      }
    }

    // ===========================================
    // 起動時に認可コード処理
    // ===========================================
    handleRedirect();
  </script>
</body>
</html>
